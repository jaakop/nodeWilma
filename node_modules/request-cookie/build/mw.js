'use strict';

var url = require('url');
var tough = require('tough-cookie');

exports.Request = function (cookie) {
  return function (_ref) {
    var options = _ref.options;


    if (cookie && !cookie.store) {
      cookie.store = new tough.CookieJar(undefined, { looseMode: true });
    }

    if (cookie && cookie.header === undefined) {
      var header = Object.keys(options.headers).find(function (name) {
        return name.toLowerCase() === 'cookie';
      });
      cookie.header = header ? options.headers[header] : false;
    }

    var uri = url.parse(`${options.protocol}//${options.hostname}${options.path}` + (options.port ? `:${options.port}` : ''));

    var cookies = cookie.store.getCookieStringSync(uri);

    if (cookies && cookies.length) {
      options.headers.cookie = cookie.header ? `${cookie.header}; ${cookies}` : cookies;
    }

    return { options };
  };
};

exports.Response = function (cookie) {
  return function (_ref2) {
    var options = _ref2.options,
        res = _ref2.res;


    var header = Object.keys(res.headers).find(function (name) {
      return name.toLowerCase() === 'set-cookie';
    });

    if (header) {
      var uri = url.parse(`${options.protocol}//${options.hostname}${options.path}` + (options.port ? `:${options.port}` : ''));[].concat(res.headers[header]).forEach(function (str) {
        try {
          cookie.store.setCookieSync(str, uri, { ignoreError: true });
        } catch (err) {}
      });
    }

    return { options, res };
  };
};